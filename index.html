<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: calc(100% + 320px); /* Ê®™ÂπÖÊã°Âºµ */
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform;
}
</style>
</head>
<body>

<div id="stage"></div>

<script>
/* ==============================
   üéÅ „ÇÆ„Éï„ÉàÂÆöÁæ©
================================ */
const GIFT_EFFECTS = {
  baseball: {
    image: "Baseball.png",
    countLimit: 20,
    duration: 3000,
    spawnInterval: 120,

    start: {
      x: [0.48, 0.52],
      y: [0.85, 0.88],
      sizeRatio: [0.06, 0.075]
    },

    end: {
      x: [0.49, 0.51],
      y: [0.30, 0.35],
      sizeRatio: [0.015, 0.02]
    }
  }
};

/* ==============================
   üîß ÂÆöÊï∞
================================ */
const CHARGE_TIME = 500;       // Ê∫ú„ÇÅÊôÇÈñì(ms)
const SHAKE_POWER = 8;        // „Éó„É´„Éó„É´ÂπÖ
const IMPACT_BOUNCE = 30;     // ÁùÄÂºæ„Ç∏„É£„É≥„Éó
const DIR_VARIANCE = 0.05;    // Êäï„ÅíÊñπÂêë„Éñ„É¨Áéá

/* ==============================
   „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
================================ */
const rand = (a, b) => Math.random() * (b - a) + a;

function easeOutExpo(t) {
  return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
}

/* ==============================
   URL„Éë„É©„É°„Éº„Çø
   ?gift=baseball&n=10
================================ */
const params = new URLSearchParams(location.search);
const giftKey = params.get("gift") || "baseball";
const rawCount = parseInt(params.get("n")) || 1;

const effect = GIFT_EFFECTS[giftKey];
const COUNT = Math.min(rawCount, effect.countLimit);

/* ==============================
   „Çπ„ÉÜ„Éº„Ç∏„Çµ„Ç§„Ç∫
================================ */
const stage = document.getElementById("stage");
const W = stage.clientWidth;
const H = stage.clientHeight;

/* ==============================
   „Ç¢„Ç§„ÉÜ„É†ÁîüÊàê
================================ */
const items = [];

function spawnItem() {
  const img = document.createElement("img");
  img.src = effect.image;
  img.className = "effect-item";

  const ss = rand(...effect.start.sizeRatio) * W;
  const es = rand(...effect.end.sizeRatio) * W;

  const offset = (items.length % 5) * 18 - 36;

  const dirShiftX = rand(-DIR_VARIANCE, DIR_VARIANCE) * W;
  const dirShiftY = rand(-DIR_VARIANCE, DIR_VARIANCE) * H;

  const item = {
    el: img,
    startTime: performance.now(),

    sx: rand(effect.start.x[0] * W, effect.start.x[1] * W) + offset,
    sy: rand(effect.start.y[0] * H, effect.start.y[1] * H),

    ex: rand(effect.end.x[0] * W, effect.end.x[1] * W) + dirShiftX,
    ey: rand(effect.end.y[0] * H, effect.end.y[1] * H) + dirShiftY,

    ss,
    es,
    rotBase: rand(-25, 25)
  };

  img.style.width = ss + "px";
  stage.appendChild(img);
  items.push(item);
}

for (let i = 0; i < COUNT; i++) {
  setTimeout(spawnItem, i * effect.spawnInterval);
}

/* ==============================
   üéû „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
================================ */
function animate(now) {
  items.forEach(it => {
    const elapsed = now - it.startTime;
    const total = effect.duration;

    let x, y, size, rotate = 0;

    /* ‚ë† Ê∫ú„ÇÅÔºà„Éó„É´„Éó„É´Ôºâ */
    if (elapsed < CHARGE_TIME) {
      const shake = Math.sin(elapsed / 50) * SHAKE_POWER;
      x = it.sx + shake;
      y = it.sy;
      size = it.ss;
      rotate = it.rotBase + shake * 0.5;
    }

    /* ‚ë° ÊäïÊì≤ */
    else {
      const throwT = Math.min(
        (elapsed - CHARGE_TIME) / (total - CHARGE_TIME),
        1
      );

      const p = easeOutExpo(throwT);

      x = it.sx + (it.ex - it.sx) * p;
      y = it.sy + (it.ey - it.sy) * p;
      size = it.ss + (it.es - it.ss) * p;

      /* ÂõûËª¢ÔºàÊäïÊì≤‰∏≠„ÅÆ„ÅøÔºâ */
      if (p < 0.85) {
        rotate = it.rotBase + (1 - p) * 360;
      }

      /* ‚ë¢ ÁùÄÂºæ„Éê„Ç¶„É≥„Éâ */
      if (p > 0.85) {
        const impactT = (p - 0.85) / 0.15;
        y += Math.sin(impactT * Math.PI) * -IMPACT_BOUNCE;
        rotate = 0;
      }
    }

    it.el.style.transform =
      `translate(${x}px, ${y}px) rotate(${rotate}deg)`;
    it.el.style.width = size + "px";
  });

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
</script>

</body>
</html>
