<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: calc(100% + 320px);
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform;
}
</style>
</head>
<body>

<div id="stage"></div>

<script>
/* ==============================
   ğŸ ã‚®ãƒ•ãƒˆå®šç¾©
================================ */
const GIFT_EFFECTS = {
  default: {
  image: "default.png",
  type: "pop",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.125, 0.125]
  }
 },
  heart_me: {
  image: "Heart_Me.png",
  type: "float",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.15, 0.15]
  }
 },
  popular_vote: {
  image: "Popular_Vote.png",
  type: "pop",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.125, 0.125]
  }
 },
  cat_paws: {
  image: "Cat_Paws.png",
  type: "pop",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.125, 0.125]
  }
 },
  rose: {
  image: "Rose.png",
  type: "throw",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.125, 0.125]
  }
 },
  love_you_so_much: {
  image: "Love_you_so_much.png",
  type: "pop",
  countLimit: 10,
  duration: 2500,
  spawnInterval: 300,

  start: {
    // ç”»é¢ä¸­å¤®ã¡ã‚‡ã„ä¸‹
    x: [0.5, 0.5],
    y: [0.4, 0.4],
    sizeRatio: [0.125, 0.125]
  }
 },
  baseball: {
    image: "Baseball.png",
    type: "throw",
    countLimit: 20,
    duration: 3200,
    spawnInterval: 120,

    start: {
      x: [0.48, 0.52],
      y: [0.67, 0.70],
      sizeRatio: [0.1, 0.125]
    },

    end: {
      x: [0.35, 0.55],
      y: [0.2, 0.4],
      sizeRatio: [0.05, 0.075]
    }
  },

  surprised_fish: {
    image: "Surprised_Fish.png",
    type: "float",
    countLimit: 30,
    duration: 6000,
    spawnInterval: 150,

    start: {
      x: [-0.15, -0.05],
      y: [0.25, 0.6],
      sizeRatio: [0.05, 0.06]
    },

    end: {
      x: [1.05, 1.15],
      y: [0.25, 0.6],
      sizeRatio: [0.05, 0.06]
    }
  }
};

/* ==============================
   ğŸ”§ å®šæ•°ï¼ˆæŠ•æ“²ç”¨ï¼‰
================================ */
const CHARGE_TIME = 500;
const SHAKE_POWER = 8;
const IMPACT_BOUNCE = 32;
const DIR_VARIANCE = 0.05;

/* ==============================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
================================ */
const rand = (a, b) => Math.random() * (b - a) + a;

function easeOutExpo(t) {
  return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
}

/* ==============================
   URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
================================ */
const params = new URLSearchParams(location.search);
const giftKey = params.get("gift") || "baseball";
const rawCount = parseInt(params.get("n")) || 1;

const effect = GIFT_EFFECTS[giftKey];
const COUNT = Math.min(rawCount, effect.countLimit);

/* ==============================
   ã‚¹ãƒ†ãƒ¼ã‚¸ã‚µã‚¤ã‚º
================================ */
const stage = document.getElementById("stage");
const W = stage.clientWidth;
const H = stage.clientHeight;

/* ==============================
   ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
================================ */
const items = [];

function spawnItem() {
  const img = document.createElement("img");
  img.src = effect.image;
  img.className = "effect-item";

  const ss = rand(...effect.start.sizeRatio) * W;
  const es = rand(...effect.end.sizeRatio) * W;

  const offset = (items.length % 6) * 20 - 50;

  const item = {
    el: img,
    startTime: performance.now(),

    sx: rand(effect.start.x[0] * W, effect.start.x[1] * W),
    sy: rand(effect.start.y[0] * H, effect.start.y[1] * H) + offset,

    ex: rand(effect.end.x[0] * W, effect.end.x[1] * W),
    ey: rand(effect.end.y[0] * H, effect.end.y[1] * H),

    ss,
    es,

    rotBase: rand(-25, 25),
    floatPhase: Math.random() * Math.PI * 2,
    impactY: null
  };

  img.style.width = ss + "px";
  stage.appendChild(img);
  items.push(item);
}

for (let i = 0; i < COUNT; i++) {
  setTimeout(spawnItem, i * effect.spawnInterval);
}

/* ==============================
   ğŸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
================================ */
function animate(now) {
  items.forEach(it => {
    const elapsed = now - it.startTime;
    const total = effect.duration;

    let x, y, size, rotate = 0;

    /* ===== ãƒãƒƒãƒ—ç³»ï¼ˆHeart Me / ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ ===== */
if (effect.type === "pop") {
  const t = Math.min(elapsed / total, 1);

  // åŸºæº–ä½ç½®ï¼ˆç”»é¢ä¸­å¤®ï¼‰
  const baseX = W * effect.start.x[0];
  const baseY = H * effect.start.y[0];

  // ã‚µã‚¤ã‚ºï¼ˆå›ºå®šï¼‰
  size = it.ss;

  // å·¦å³ã‚†ã‚‰ã‚†ã‚‰
  rotate = Math.sin(t * 4 + it.floatPhase) * 10;

  // ä¸Šä¸‹ã´ã‚‡ã“ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  let popOffset = 0;

  // å‡ºç¾ï¼ˆä¸‹ â†’ å®šä½ç½®ï¼‰
  if (t < 0.2) {
    const p = easeOutExpo(t / 0.2);
    popOffset = (1 - p) * 40;
  }
  // æ¶ˆæ»…ï¼ˆå®šä½ç½® â†’ ä¸‹ï¼‰
  else if (t > 0.8) {
    const p = (t - 0.8) / 0.2;
    popOffset = p * 40;
  }

  x = baseX;
  y = baseY + popOffset;
}

    /* ===== æŠ•æ“²ç³»ï¼ˆé‡çƒãƒœãƒ¼ãƒ«ï¼‰ ===== */
    if (effect.type === "throw") {

  /* ===== æºœã‚ ===== */
  if (elapsed < CHARGE_TIME) {
    const shake = Math.sin(elapsed / 50) * SHAKE_POWER;
    x = it.sx + shake;
    y = it.sy;
    size = it.ss;
    rotate = it.rotBase + shake * 0.5;
  }

  /* ===== æŠ•æ“²ã€œç€å¼¾ ===== */
  else {
    const throwT = Math.min(
      (elapsed - CHARGE_TIME) / (total - CHARGE_TIME),
      1
    );
    const p = easeOutExpo(throwT);

    /* ===== æŠ•æ“²ä¸­ ===== */
    if (p < 0.85 && it.state !== "fall") {
      x = it.sx + (it.ex - it.sx) * p;
      y = it.sy + (it.ey - it.sy) * p;
      size = it.ss + (it.es - it.ss) * p;
      rotate = it.rotBase + (1 - p) * 360;
    }

    /* ===== ç€å¼¾ â†’ è½ä¸‹é–‹å§‹ ===== */
    else {
      if (it.state !== "fall") {
        // ç€å¼¾ã—ãŸç¬é–“ã®åˆæœŸåŒ–
        it.state = "fall";
        it.x = it.ex;
        it.y = it.ey;
        it.vy = -IMPACT_BOUNCE * 0.1; // ã´ã‚‡ã‚“
        size = it.es;
        rotate = 0;
      }

      // é‡åŠ›
      it.vy += 1.2;
      it.y += it.vy;

      x = it.x;
      y = it.y;
      size = it.es;
      rotate = 0;
    }
  }
}

    /* ===== æµ®éŠç³»ï¼ˆé­šï¼‰ ===== */
    if (effect.type === "float") {
      const t = Math.min(elapsed / total, 1);
      x = it.sx + (it.ex - it.sx) * t;
      y = it.sy + Math.sin(t * 6 + it.floatPhase) * 20;
      size = it.ss;
      rotate = Math.sin(t * 4 + it.floatPhase) * 15;
    }

    it.el.style.transform =
      `translate(${x}px, ${y}px) rotate(${rotate}deg)`;
    it.el.style.width = size + "px";
  });

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
</script>

</body>
</html>
