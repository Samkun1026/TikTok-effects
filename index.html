<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: calc(100% + 320px);
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform;
}
</style>
</head>
<body>

<div id="stage"></div>

<script>
/* ==============================
   ğŸ ã‚®ãƒ•ãƒˆå®šç¾©
================================ */
const GIFT_EFFECTS = {

  default: {
    image: "default.png",
    type: "pop",
    countLimit: 10,
    duration: 4000,
    spawnInterval: 300,
    start:{ x:[0.5,0.5], y:[0.4,0.4], sizeRatio:[0.125,0.125] },
    end:{ x:[0.5,0.5], y:[0.4,0.4], sizeRatio:[0.125,0.125] }
  },

  heart_me: {
    image: "Heart_Me.png",
    type: "pop",
    countLimit: 10,
    duration: 4000,
    spawnInterval: 300,
    start:{ x:[0.5,0.5], y:[0.4,0.4], sizeRatio:[0.15,0.15] },
    end:{ x:[0.5,0.5], y:[0.4,0.4], sizeRatio:[0.125,0.125] }
  },

  popular_vote: {
    image: "Popular_Vote.png",
    type: "popular",
    countLimit: 30,
    duration: 999999,
    spawnInterval: 200,
    start:{ x:[0.0,0.05], y:[0.9,1.0], sizeRatio:[0.08,0.1] }
  },

  baseball: {
    image: "Baseball.png",
    type: "throw",
    countLimit: 20,
    duration: 3200,
    spawnInterval: 120,
    start:{ x:[0.48,0.52], y:[0.67,0.70], sizeRatio:[0.1,0.125] },
    end:{ x:[0.35,0.55], y:[0.2,0.4], sizeRatio:[0.05,0.075] }
  },

  surprised_fish: {
    image: "Surprised_Fish.png",
    type: "float",
    countLimit: 30,
    duration: 6000,
    spawnInterval: 150,
    start:{ x:[-0.15,-0.05], y:[0.25,0.6], sizeRatio:[0.05,0.06] },
    end:{ x:[1.05,1.15], y:[0.25,0.6], sizeRatio:[0.05,0.06] }
  }
};

/* ==============================
   å®šæ•°ï¼ˆthrowï¼‰
================================ */
const CHARGE_TIME = 500;
const SHAKE_POWER = 8;
const IMPACT_BOUNCE = 32;

/* ==============================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
================================ */
const rand = (a,b)=>Math.random()*(b-a)+a;
const easeOutExpo = t => (t===1?1:1-Math.pow(2,-10*t));

/* ==============================
   URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
================================ */
const params = new URLSearchParams(location.search);
const giftKey = params.get("gift") || "baseball";
const rawCount = parseInt(params.get("n")) || 1;

const effect = GIFT_EFFECTS[giftKey];
const COUNT = Math.min(rawCount, effect.countLimit);

/* ==============================
   ã‚¹ãƒ†ãƒ¼ã‚¸
================================ */
const stage = document.getElementById("stage");
const W = stage.clientWidth;
const H = stage.clientHeight;

/* ==============================
   ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆï¼ˆæœ€åˆã®ã¾ã¾ï¼‰
================================ */
const items = [];

function spawnItem(){
  const img=document.createElement("img");
  img.src=effect.image;
  img.className="effect-item";

  const ss=rand(...effect.start.sizeRatio)*W;
  const es=effect.end?.sizeRatio?rand(...effect.end.sizeRatio)*W:ss;

  const offset=(items.length%6)*20-50;

  const item={
    el:img,
    startTime:performance.now(),
    sx:rand(effect.start.x[0]*W,effect.start.x[1]*W),
    sy:rand(effect.start.y[0]*H,effect.start.y[1]*H)+offset,
    ex:effect.end?.x?rand(effect.end.x[0]*W,effect.end.x[1]*W):0,
    ey:effect.end?.y?rand(effect.end.y[0]*H,effect.end.y[1]*H):0,
    ss,es,
    rotBase:rand(-25,25),
    floatPhase:Math.random()*Math.PI*2,
    impactY:null
  };

  img.style.width=ss+"px";
  stage.appendChild(img);
  items.push(item);
}

for(let i=0;i<COUNT;i++){
  setTimeout(spawnItem,i*effect.spawnInterval);
}

/* ==============================
   ğŸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
================================ */
function animate(now){
  items.forEach(it=>{
    const elapsed=now-it.startTime;
    const total=effect.duration;

    let x,y,size,rotate=0;

    /* ===== popï¼ˆæœ€åˆã®æŒ™å‹•ãã®ã¾ã¾ï¼‰ ===== */
    if(effect.type==="pop"){
      const t=Math.min(elapsed/total,1);
      const baseX=W*effect.start.x[0];
      const baseY=H*effect.start.y[0];
      size=it.ss;
      rotate=Math.sin(t*4+it.floatPhase)*10;

      let popOffset=0;
      if(t<0.2){
        const p=easeOutExpo(t/0.2);
        popOffset=(1-p)*40;
      }else if(t>0.8){
        const p=(t-0.8)/0.2;
        popOffset=p*40;
      }
      x=baseX;
      y=baseY+popOffset;
    }

    /* ===== throwï¼ˆæœ€åˆã®æŒ™å‹•ãã®ã¾ã¾ï¼‰ ===== */
    if(effect.type==="throw"){
      if(elapsed<CHARGE_TIME){
        const shake=Math.sin(elapsed/50)*SHAKE_POWER;
        x=it.sx+shake;
        y=it.sy;
        size=it.ss;
        rotate=it.rotBase+shake*0.5;
      }else{
        const throwT=Math.min((elapsed-CHARGE_TIME)/(total-CHARGE_TIME),1);
        const p=easeOutExpo(throwT);
        if(p<0.85&&it.state!=="fall"){
          x=it.sx+(it.ex-it.sx)*p;
          y=it.sy+(it.ey-it.sy)*p;
          size=it.ss+(it.es-it.ss)*p;
          rotate=it.rotBase+(1-p)*360;
        }else{
          if(it.state!=="fall"){
            it.state="fall";
            it.x=it.ex;
            it.y=it.ey;
            it.vy=-IMPACT_BOUNCE*0.1;
            size=it.es;
          }
          it.vy+=1.2;
          it.y+=it.vy;
          x=it.x;
          y=it.y;
          size=it.es;
        }
      }
    }

    /* ===== floatï¼ˆæœ€åˆã®æŒ™å‹•ãã®ã¾ã¾ï¼‰ ===== */
    if(effect.type==="float"){
      const t=Math.min(elapsed/total,1);
      x=it.sx+(it.ex-it.sx)*t;
      y=it.sy+Math.sin(t*6+it.floatPhase)*20;
      size=it.ss;
      rotate=Math.sin(t*4+it.floatPhase)*15;
    }

    /* ===== popular_voteï¼ˆè¿½åŠ ï¼‰ ===== */
    if(effect.type==="popular"){
      if(!it.init){
        it.speed=rand(0.35,0.45);
        it.radius=rand(0.35,0.45)*H;
        it.init=true;
      }
      const p=elapsed*0.001*it.speed;
      const angle=-Math.PI/2+(p%1)*(Math.PI/2);

      x=it.sx+p*W*0.45+Math.cos(angle)*it.radius;
      y=it.sy-p*H*0.3+Math.sin(angle)*it.radius;
      size=it.ss;
      rotate=Math.sin(p*2)*8;

      if(x>W+it.ss||y<-it.ss){
        it.el.remove();
        it.dead=true;
      }
    }

    if(it.dead)return;

    it.el.style.transform=
      `translate(${x}px,${y}px) rotate(${rotate}deg)`;
    it.el.style.width=size+"px";
  });

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>

</body>
</html>
