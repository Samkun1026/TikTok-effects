<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: calc(100% + 320px);
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform, opacity;
}
</style>
</head>
<body>

<div id="stage"></div>

<script>
/* =====================================================
   üéÅ „ÇÆ„Éï„ÉàÂÆöÁæ©Ôºà„Åì„Åì„Å†„ÅëËß¶„Çå„Å∞Â¢ó„ÇÑ„Åõ„ÇãÔºâ
===================================================== */
const GIFT_EFFECTS = {

  heart_me: {
    image: "Heart_Me.png",
    motion: "heartPop",
    countLimit: 1,
    duration: 4000,
    spawnInterval: 0,
    sizeRatio: [0.15, 0.15]
  },

  baseball: {
    image: "Baseball.png",
    motion: "throw",
    countLimit: 20,
    duration: 3200,
    spawnInterval: 120,
    start: { x:[0.48,0.52], y:[0.67,0.70], sizeRatio:[0.1,0.125] },
    end:   { x:[0.35,0.55], y:[0.2,0.4],   sizeRatio:[0.05,0.075] }
  },

  surprised_fish: {
    image: "Surprised_Fish.png",
    motion: "float",
    countLimit: 30,
    duration: 6000,
    spawnInterval: 150,
    start: { x:[-0.15,-0.05], y:[0.25,0.6], sizeRatio:[0.05,0.06] },
    end:   { x:[1.05,1.15],   y:[0.25,0.6], sizeRatio:[0.05,0.06] }
  },

  popular_vote: {
    image: "Popular_Vote.png",
    motion: "curveThree",
    countLimit: 30,
    duration: 8000,
    spawnInterval: 180,
    start: { x:[0.02,0.05], y:[0.88,0.92], sizeRatio:[0.08,0.1] }
  }
};

/* =====================================================
   ÂÆöÊï∞
===================================================== */
const CHARGE_TIME = 500;
const SHAKE_POWER = 8;
const IMPACT_BOUNCE = 32;

/* =====================================================
   „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
===================================================== */
const rand = (a,b)=>Math.random()*(b-a)+a;
const easeOutExpo = t => t===1?1:1-Math.pow(2,-10*t);

/* =====================================================
   URL„Éë„É©„É°„Éº„Çø
===================================================== */
const params = new URLSearchParams(location.search);
const giftKey = params.get("gift") || "heart_me";
const rawCount = parseInt(params.get("n")) || 1;

const effect = GIFT_EFFECTS[giftKey];
const COUNT = Math.min(rawCount, effect.countLimit);

/* =====================================================
   „Çπ„ÉÜ„Éº„Ç∏
===================================================== */
const stage = document.getElementById("stage");
const W = stage.clientWidth;
const H = stage.clientHeight;

/* =====================================================
   spawnItemÔºàËß¶„Çâ„Å™„Åè„Å¶„ÅÑ„ÅÑÔºâ
===================================================== */
const items = [];

function spawnItem() {
  const img = document.createElement("img");
  img.src = effect.image;
  img.className = "effect-item";

  const ss = rand(...(effect.sizeRatio || effect.start.sizeRatio)) * W;

  const item = {
    el: img,
    startTime: performance.now(),
    ss,
    phase: Math.random()*Math.PI*2,
    dead: false,

    sx: effect.start?.x ? rand(effect.start.x[0]*W, effect.start.x[1]*W) : W/2,
    sy: effect.start?.y ? rand(effect.start.y[0]*H, effect.start.y[1]*H) : H,

    ex: effect.end?.x ? rand(effect.end.x[0]*W, effect.end.x[1]*W) : 0,
    ey: effect.end?.y ? rand(effect.end.y[0]*H, effect.end.y[1]*H) : 0,

    state: null,
    vy: 0
  };

  img.style.width = ss+"px";
  img.style.opacity = 1;
  stage.appendChild(img);
  items.push(item);
}

for(let i=0;i<COUNT;i++){
  setTimeout(spawnItem, i*effect.spawnInterval);
}

/* =====================================================
   üéû „É¢„Éº„Ç∑„Éß„É≥ÂÆöÁæ©Ôºà„Åì„Åì„Å´Ë∂≥„Åô„Å†„ÅëÔºâ
===================================================== */
const MOTIONS = {

  /* ‚ù§Ô∏è Heart Me */
  heartPop(it, t) {
    let x = W/2, y, r = 0;

    if (t < 0.2) {
      const p = easeOutExpo(t/0.2);
      y = H - p*(H/2);
    }
    else if (t < 0.8) {
      const f = (t-0.2)/0.6;
      y = H/2 + Math.sin(f*4+it.phase)*20;
      r = Math.sin(f*3+it.phase)*8;
    }
    else {
      const p = (t-0.8)/0.2;
      y = H/2 + p*(H/2+200);
      it.el.style.opacity = 1-p;
    }

    return {x,y,rotate:r};
  },

  /* ‚öæ throw */
  throw(it, elapsed, total) {
    let x,y,size=it.ss,r=0;

    if (elapsed < CHARGE_TIME) {
      const shake = Math.sin(elapsed/50)*SHAKE_POWER;
      x = it.sx+shake; y = it.sy;
      r = shake*0.5;
    } else {
      const p = easeOutExpo((elapsed-CHARGE_TIME)/(total-CHARGE_TIME));
      if (p < 0.85 && !it.state) {
        x = it.sx+(it.ex-it.sx)*p;
        y = it.sy+(it.ey-it.sy)*p;
        r = (1-p)*360;
      } else {
        if (!it.state) {
          it.state="fall";
          it.vy=-IMPACT_BOUNCE*0.1;
          it.x=it.ex; it.y=it.ey;
        }
        it.vy+=1.2;
        it.y+=it.vy;
        x=it.x; y=it.y;
      }
    }
    return {x,y,rotate:r};
  },

  /* üêü float */
  float(it, t) {
    return {
      x: it.sx+(it.ex-it.sx)*t,
      y: it.sy+Math.sin(t*6+it.phase)*20,
      rotate: Math.sin(t*4+it.phase)*15
    };
  },

  /* üó≥ Popular VoteÔºàÂè≥ÂÇæ„Åç3ËªåÈÅìÔºâ */
  curveThree(it, elapsed) {
    const p = elapsed*0.0005;
    const curve = Math.sin(p*Math.PI*2);
    const x = it.sx + p*W*0.6;
    const y = it.sy - p*H*0.6 + curve*80;
    return {x,y,rotate:curve*6};
  }
};

/* =====================================================
   „É°„Ç§„É≥„É´„Éº„Éó
===================================================== */
function animate(now){
  items.forEach(it=>{
    if(it.dead) return;

    const elapsed = now-it.startTime;
    const t = elapsed/effect.duration;

    if (t >= 1) {
      it.el.remove();
      it.dead = true;
      return;
    }

    const motion = MOTIONS[effect.motion];
    if (!motion) return;

    const res = motion(it, t, effect.duration) || {};
    it.el.style.transform =
      `translate(${res.x}px,${res.y}px) rotate(${res.rotate||0}deg)`;
  });

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>
</body>
</html>
