<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: 100%;
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform, opacity;
}
</style>
</head>
<body>

<div id="stage"></div>

<script>
/* ==============================
   üéÅ „ÇÆ„Éï„ÉàÂÆöÁæ©
================================ */
const GIFT_EFFECTS = {
  heart_me: {
    image: "Heart_Me.png",
    type: "pop",
    countLimit: 1,
    duration: 4000,
    spawnInterval: 0,
    start: { sizeRatio: [0.15, 0.15] }
  },

  baseball: {
    image: "Baseball.png",
    type: "throw",
    countLimit: 20,
    duration: 3200,
    spawnInterval: 120,
    start: {
      x: [0.48, 0.52],
      y: [0.67, 0.7],
      sizeRatio: [0.1, 0.12]
    },
    end: {
      x: [0.35, 0.55],
      y: [0.2, 0.4],
      sizeRatio: [0.05, 0.07]
    }
  },

  surprised_fish: {
    image: "Surprised_Fish.png",
    type: "float",
    countLimit: 30,
    duration: 6000,
    spawnInterval: 150,
    start: {
      x: [-0.15, -0.05],
      y: [0.3, 0.6],
      sizeRatio: [0.05, 0.06]
    },
    end: {
      x: [1.05, 1.15],
      y: [0.3, 0.6],
      sizeRatio: [0.05, 0.06]
    }
  }
};

/* ==============================
   „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
================================ */
const rand = (a, b) => Math.random() * (b - a) + a;
const easeOut = t => 1 - Math.pow(1 - t, 3);

/* ==============================
   URL„Éë„É©„É°„Éº„Çø
================================ */
const params = new URLSearchParams(location.search);
const giftKey = params.get("gift") || "heart_me";
const rawCount = parseInt(params.get("n")) || 1;

const effect = GIFT_EFFECTS[giftKey];
const COUNT = Math.min(rawCount, effect.countLimit);

/* ==============================
   „Çπ„ÉÜ„Éº„Ç∏
================================ */
const stage = document.getElementById("stage");
const W = stage.clientWidth;
const H = stage.clientHeight;

/* ==============================
   „Ç¢„Ç§„ÉÜ„É†ÁîüÊàê
================================ */
const items = [];

function spawnItem() {
  const img = document.createElement("img");
  img.src = effect.image;
  img.className = "effect-item";

  const size = rand(...effect.start.sizeRatio) * W;

  const item = {
    el: img,
    startTime: performance.now(),
    size,
    phase: Math.random() * Math.PI * 2,
    dead: false
  };

  img.style.width = size + "px";
  img.style.opacity = 1;
  stage.appendChild(img);
  items.push(item);
}

for (let i = 0; i < COUNT; i++) {
  setTimeout(spawnItem, i * effect.spawnInterval);
}

/* ==============================
   üéû „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
================================ */
function animate(now) {
  items.forEach(it => {
    if (it.dead) return;

    const elapsed = now - it.startTime;
    const total = effect.duration;
    const t = Math.min(elapsed / total, 1);

    let x = W / 2;
    let y = H / 2;
    let rotate = 0;

    /* ===== pop ===== */
    if (effect.type === "pop") {

      // Âá∫ÁèæÔºö‰∏ã„Åã„ÇâÂã¢„ÅÑ„Çà„Åè
      if (t < 0.2) {
        const p = easeOut(t / 0.2);
        y = H + (H / 2 - H) * p;
      }

      // ÂæÖÊ©üÔºö„Å∑„Åã„Å∑„ÅãÔºãÂõûËª¢
      else if (t < 0.8) {
        const f = (t - 0.2) / 0.6;
        y = H / 2 + Math.sin(f * 4 + it.phase) * 20;
        rotate = Math.sin(f * 2 + it.phase) * 8;
      }

      // Ê∂àÊªÖÔºö„Å¥„Çá„ÇìÔºÅ„Å£„Å¶‰∏ã„Å∏
      else {
        const p = (t - 0.8) / 0.2;
        y = H / 2 + easeOut(p) * (H / 2 + 200);
        it.el.style.opacity = 1 - p;
      }
    }

    /* ===== throw ===== */
    if (effect.type === "throw") {
      const sx = W * rand(...effect.start.x);
      const sy = H * rand(...effect.start.y);
      const ex = W * rand(...effect.end.x);
      const ey = H * rand(...effect.end.y);

      const p = easeOut(t);
      x = sx + (ex - sx) * p;
      y = sy + (ey - sy) * p;
      rotate = (1 - p) * 360;

      if (t > 0.8) it.el.style.opacity = 1 - (t - 0.8) / 0.2;
    }

    /* ===== float ===== */
    if (effect.type === "float") {
      const sx = W * rand(...effect.start.x);
      const ex = W * rand(...effect.end.x);

      x = sx + (ex - sx) * t;
      y = H / 2 + Math.sin(t * 6 + it.phase) * 30;
      rotate = Math.sin(t * 4 + it.phase) * 12;

      if (t > 0.85) it.el.style.opacity = 1 - (t - 0.85) / 0.15;
    }

    it.el.style.transform =
      `translate(${x - it.size / 2}px, ${y - it.size / 2}px) rotate(${rotate}deg)`;

    /* ===== ÂÆåÂÖ®ÂâäÈô§ ===== */
    if (elapsed > total) {
      it.el.remove();
      it.dead = true;
    }
  });

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
</script>

</body>
</html>
