<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Gift Effect Engine</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0) !important;
  overflow: hidden;
}

#stage {
  position: absolute;
  left: 50%;
  top: 0;
  width: calc(100% + 320px);
  height: 100%;
  transform: translateX(-50%);
  pointer-events: none;
}

.effect-item {
  position: absolute;
  will-change: transform, opacity;
}
</style>
</head>
<body>
<div id="stage"></div>

<script>
/* ==============================
   üéÅ „ÇÆ„Éï„ÉàÂÆöÁæ©Ôºà„Åù„ÅÆ„Åæ„ÅæÔºâ
================================ */
const GIFT_EFFECTS = {
  heart_me: {
    image: "Heart_Me.png",
    type: "pop",
    countLimit: 1,
    duration: 4000,
    spawnInterval: 0,
    start: { sizeRatio: [0.15, 0.15] }
  },
  cool_love: {
    image: "Cool_love.png",
    type: "pop",
    countLimit: 1,
    duration: 4000,
    spawnInterval: 0,
    start: { sizeRatio: [0.11, 0.11] }
  },
  popular_vote: {
    image: "Popular_Vote.png",
    type: "popular",
    countLimit: 20,
    duration: 3000,
    spawnInterval: 150,
    start: { x: [0.15, 0.20], y: [0.77, 0.83], sizeRatio: [0.12, 0.12] },
    end: { x: [0.85, 0.95], y: [-0.15, -0.05] }
  },
  baseball: {
    image: "Baseball.png",
    type: "throw",
    countLimit: 20,
    duration: 3200,
    spawnInterval: 120,
    start: { x: [0.48, 0.52], y: [0.67, 0.70], sizeRatio: [0.1, 0.125] },
    end: { x: [0.35, 0.55], y: [0.2, 0.4], sizeRatio: [0.05, 0.075] }
  },
  suprised_fish: {
    image: "Surprised_Fish.png",
    type: "float",
    countLimit: 30,
    duration: 6000,
    spawnInterval: 150,
    start: { x: [-0.15, -0.05], y: [0.25, 0.6], sizeRatio: [0.05, 0.06] },
    end: { x: [1.05, 1.15], y: [0.25, 0.6], sizeRatio: [0.05, 0.06] }
  }
};

/* ==============================
   ÂÆöÊï∞ÔºàthrowÂéüÂûãÔºâ
================================ */
const CHARGE_TIME = 500;
const SHAKE_POWER = 8;
const IMPACT_BOUNCE = 32;

/* ==============================
   „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
================================ */
const rand = (a,b) => Math.random()*(b-a)+a;
const easeOutExpo = t => (t===1?1:1-Math.pow(2,-10*t));

function parseGiftText(text) {
  const match = text.match(/^(.+?)\(\d+\)\s*x\s*(\d+)$/i);
  if (!match) return null;
  const gift = match[1].trim().toLowerCase().replace(/\s+/g,"_");
  const count = parseInt(match[2],10);
  return { gift, count };
}

/* ==============================
   „Çπ„ÉÜ„Éº„Ç∏„Å®„Ç¢„Ç§„ÉÜ„É†ÁîüÊàê
================================ */
const stage = document.getElementById("stage");
const items = [];

function spawnItem(effect) {
  const W = stage.clientWidth;
  const H = stage.clientHeight;

  const img = document.createElement("img");
  img.src = effect.image;
  img.className = "effect-item";

  const ss = rand(...effect.start.sizeRatio)*W;
  const es = effect.end?.sizeRatio ? rand(...effect.end.sizeRatio)*W : ss;

  const item = {
    el: img,
    startTime: performance.now(),
    ss,
    es,
    phase: Math.random()*Math.PI*2,
    rotBase: rand(-25,25),
    dead: false,
    sx: effect.start.x ? rand(...effect.start.x.map(v=>v*W)) : W/2,
    sy: effect.start.y ? rand(...effect.start.y.map(v=>v*H)) : H,
    ex: effect.end?.x ? rand(...effect.end.x.map(v=>v*W)) : W/2,
    ey: effect.end?.y ? rand(...effect.end.y.map(v=>v*H)) : H/2,
    effect
  };

  img.style.width = ss + "px";
  img.style.opacity = 1;
  stage.appendChild(img);
  items.push(item);
}

/* ==============================
   „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà„Åù„ÅÆ„Åæ„ÅæÔºâ
================================ */
function animate(now) {
  const W = stage.clientWidth;
  const H = stage.clientHeight;

  items.forEach(it=>{
    if(it.dead) return;

    const elapsed = now - it.startTime;
    const total = it.effect.duration;
    const t = Math.min(elapsed/total,1);

    let x = it.sx;
    let y = it.sy;
    let size = it.ss;
    let rotate = 0;
    const effect = it.effect;

    if(effect.type==="pop"){
      const floatY = Math.sin(t*8+it.phase)*18;
      const swayRot = Math.sin(t*6+it.phase)*8;
      if(t<0.2){ const p=easeOutExpo(t/0.2); x=W/2; y=H+(H/2-H)*p+floatY;}
      else if(t<0.8){ x=W/2; y=H/2+floatY; }
      else{ const p=(t-0.8)/0.2; x=W/2; y=H/2+easeOutExpo(p)*(H/2+200)+floatY; it.el.style.opacity=1-p;}
      rotate=swayRot;
    }
    if(effect.type==="popular"){
      const p=t;
      x=it.sx+(it.ex-it.sx)*p;
      const py=p*p;
      y=it.sy+(it.ey-it.sy)*py;
      rotate=0;
      if(p>0.85) it.el.style.opacity=1-(p-0.85)/0.15;
    }
    if(effect.type==="throw"){
      if(elapsed<CHARGE_TIME){ const shake=Math.sin(elapsed/50)*SHAKE_POWER; x=it.sx+shake; y=it.sy; rotate=it.rotBase+shake*0.5; }
      else{
        const throwT=Math.min((elapsed-CHARGE_TIME)/(total-CHARGE_TIME),1);
        const p=easeOutExpo(throwT);
        if(p<0.85&&!it.state){ x=it.sx+(it.ex-it.sx)*p; y=it.sy+(it.ey-it.sy)*p; size=it.ss+(it.es-it.ss)*p; rotate=it.rotBase+(1-p)*360; }
        else{
          if(!it.state){ it.state="fall"; it.x=it.ex; it.y=it.ey; it.vy=-IMPACT_BOUNCE*0.1;}
          it.vy+=1.2; it.y+=it.vy; x=it.x; y=it.y; size=it.es;
        }
      }
      if(t>0.85) it.el.style.opacity=1-(t-0.85)/0.15;
    }
    if(effect.type==="float"){ x=it.sx+(it.ex-it.sx)*t; y=it.sy+Math.sin(t*6+it.phase)*20; rotate=Math.sin(t*4+it.phase)*15; if(t>0.85) it.el.style.opacity=1-(t-0.85)/0.15; }

    it.el.style.transform=`translate(${x-size/2}px,${y-size/2}px) rotate(${rotate}deg)`;
    it.el.style.width=size+"px";

    if(elapsed>total){ it.el.remove(); it.dead=true; }
  });

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);

/* ==============================
   üéÆ „ÇÆ„Éï„ÉàÂÜçÁîü„Ç≠„É•„Éº
================================ */
const giftQueue = [];
let isPlaying = false;

function playGift(giftKey, count){
  if(!GIFT_EFFECTS[giftKey]) return;
  const effect = GIFT_EFFECTS[giftKey];
  const COUNT = Math.min(count,effect.countLimit);
  for(let i=0;i<COUNT;i++){
    setTimeout(()=>spawnItem(effect), i*effect.spawnInterval);
  }
}

function playNext(){
  if(isPlaying) return;
  if(giftQueue.length===0) return;
  isPlaying=true;
  const { gift, count } = giftQueue.shift();
  playGift(gift,count);
  const checkInterval = setInterval(()=>{
    if(items.every(it=>it.dead)){
      isPlaying=false;
      clearInterval(checkInterval);
      playNext();
    }
  },300);
}

/* ==============================
   üîå WebSocketÊé•Á∂öÔºà„Çµ„Éº„Éê„Éº„Åã„Çâ„ÇÆ„Éï„ÉàÂèó‰ø°Ôºâ
================================ */
const ws = new WebSocket("ws://localhost:3001");

ws.onopen = () => console.log("üü¢ „Çµ„Éº„Éê„ÉºÊé•Á∂öÂÆå‰∫Ü");

ws.onmessage = e=>{
  try{
    const data = JSON.parse(e.data);
    if(data.type!=="gift") return;
    const giftKey = data.name.toLowerCase().replace(/\s+/g,"_");
    giftQueue.push({ gift: giftKey, count: data.count });
    playNext();
  }catch(err){
    console.error("‚ùå Âèó‰ø°„Ç®„É©„Éº", err);
  }
};

ws.onerror = err => console.error("‚ùå WebSocket „Ç®„É©„Éº", err);
</script>
</body>
</html>
